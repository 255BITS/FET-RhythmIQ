{% extends "base.html" %}

{% block content %}
<div class="player-content" x-data="{
    isPlaying: false,
    currentTime: 0,
    duration: 0,
    progress: 0,
    updateProgress() {
        this.currentTime = this.$refs.audioPlayer.currentTime;
        this.duration = this.$refs.audioPlayer.duration || 0;
        this.progress = (this.currentTime / this.duration) * 100;
    }
}">
    <div class="now-playing">
        <div class="current-track-container">
            <img src="{{ current_song.image_large_url|default('/static/images/placeholder.jpg', true) }}"
                 alt="Album Cover" 
                 class="cover-image">
            <div class="track-info">
                <audio id="audio-player" x-ref="audioPlayer" src="{{ current_song.audio_url }}" x-on:timeupdate="updateProgress()"></audio>

                <span class="label">Now Playing:</span>
                <span class="song-title" id="current-song" 
                      hx-get="/current-song"
                      hx-trigger="load">
                    {{ current_song.name|default('No track playing') }}
                </span>
                <span class="status-tag">{{ current_song.status }}</span>
            </div>
            <script>
                document.addEventListener('htmx:afterOnLoad', function(evt) {
                    if (evt.detail.target.id === 'current-song') {
                        const audioPlayer = document.getElementById('audio-player');
                        audioPlayer.src = "{{ current_song.audio_url }}";
                    }
                });
            </script>
        </div>
    </div>
    
    <div class="progress-bar" id="song-progress">
        <div class="progress-fill" x-bind:style="{ width: progress + '%' }"></div>
    </div>
    
    <div class="controls">
        <button class="control-btn play-btn" 
                x-on:click="
                    isPlaying = !isPlaying;
                    if (isPlaying) {
                        $refs.audioPlayer.play();
                    } else {
                        $refs.audioPlayer.pause();
                    }
                "
                x-bind:class="{ 'active': isPlaying }"
                hx-post="/toggle-play"
                hx-swap="none">
            <span class="play-icon" x-text="isPlaying ? '⏸' : '▶'"></span>
        </button>
        <button class="control-btn skip-btn" 
                hx-post="/skip-song"
                hx-swap="none">
            <span class="skip-icon">⏭</span>
        </button>
    </div>
    
    <div class="queue-section">
        <h2 class="queue-title">Next Up</h2>
        <div class="queue-list"
             id="queue-container"
             hx-get="/queue"
             hx-trigger="load, every 5s"
             hx-swap="innerHTML">
        </div>
    </div>
</div>
{% endblock %}
